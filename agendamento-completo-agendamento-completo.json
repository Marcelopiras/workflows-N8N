{"updatedAt":"2025-12-20T14:05:41.656Z","createdAt":"2025-12-13T18:44:44.265Z","id":"BroWHCVVUnywRqMM","name":"Agendamento Completo","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"whatsapp-webhook","options":{}},"name":"Gatilho WhatsApp","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-160,320],"webhookId":"whatsapp-webhook","id":"2a24d0d5-38a8-4a46-ac6d-87df17e3d928"},{"parameters":{},"name":"Verifica Mensagem Vazia","type":"n8n-nodes-base.if","typeVersion":1,"position":[96,288],"conditions":{"string":[{"value1":"={{ $json.body.message }}","operation":"isNotEmpty"}]},"id":"278153ed-bbcc-42de-a683-2ab02ba8c1f9"},{"parameters":{"operation":"executeQuery","additionalFields":{}},"name":"Buscar Usuário","type":"n8n-nodes-base.postgres","typeVersion":1,"position":[368,288],"options":{"query":"SELECT * FROM pacientes WHERE telefone = '{{ $json.body.from }}';"},"id":"d3d401bf-2252-4db7-81be-44ccbfb7ccf5","credentials":{"postgres":{"id":"niNmVg2ZPUjIgaUJ","name":"Postgres account"}}},{"parameters":{"functionCode":"// Se paciente não existe, cria no banco\nif($json.length === 0){\n  return [{ json: { criarPaciente: true } }];\n} else {\n  return [{ json: { criarPaciente: false, paciente: $json[0] } }];\n}"},"name":"Verifica Se Cria Paciente","type":"n8n-nodes-base.function","typeVersion":1,"position":[576,288],"id":"7362aad2-aa59-416a-8a12-220dfc7ff08d"},{"parameters":{"functionCode":"// Calcula 3 horários livres\nconst eventosOcupados = $('Buscar eventos').all().map(i => i.json);\nconst duracaoConsulta = 60;\nconst horariosDisponiveis = [];\nlet inicioBusca = new Date();\ninicioBusca.setHours(8,0,0,0);\nwhile(horariosDisponiveis.length<3){\n  const fimConsulta = new Date(inicioBusca.getTime() + duracaoConsulta*60000);\n  const ocupado = eventosOcupados.some(ev=>{\n    const inicioEv = new Date(ev.start?.dateTime||ev.start?.date);\n    const fimEv = new Date(ev.end?.dateTime||ev.end?.date);\n    return inicioBusca<fimEv && fimConsulta>inicioEv;\n  });\n  if(!ocupado){ horariosDisponiveis.push(inicioBusca.toISOString()); }\n  inicioBusca.setHours(inicioBusca.getHours()+1);\n}\nreturn [{ json: { opcoes_horarios: horariosDisponiveis } }];"},"name":"Calcular Horários Livres","type":"n8n-nodes-base.function","typeVersion":1,"position":[784,272],"id":"0d8df2f9-b125-4f56-9d75-a0582eff32b9"},{"parameters":{"functionCode":"// Interpreta escolha do paciente\nconst resposta = $json.body.message.trim();\nconst horarios = $json.opcoes_horarios;\nlet indice = parseInt(resposta)-1;\nif(isNaN(indice) || indice<0 || indice>=horarios.length){\n  return [{ json: { erro: 'Escolha inválida' } }];\n}\nreturn [{ json: { horarioSelecionado: horarios[indice] } }];"},"name":"Interpretar Escolha","type":"n8n-nodes-base.function","typeVersion":1,"position":[1008,288],"id":"eecdc183-c258-4fbd-a9ef-9372c44f5ac8"},{"parameters":{"calendar":{"__rl":true,"value":"marcelopiraz@gmail.com","mode":"list","cachedResultName":"marcelopiraz@gmail.com"},"start":"={{ $json.horarioSelecionado }}","end":"={{ new Date(new Date($json.horarioSelecionado).getTime() + 60*60000).toISOString() }}","additionalFields":{}},"name":"Criar Evento Google Calendar","type":"n8n-nodes-base.googleCalendar","typeVersion":1,"position":[1216,288],"id":"326e1d22-d42c-4035-8183-0f873a49e651","credentials":{"googleCalendarOAuth2Api":{"id":"MegT4bnkKGZdYjSM","name":"Google Calendar account"}}},{"parameters":{"requestMethod":"POST","url":"https://api.whatsapp.com/sendMessage","jsonParameters":true,"options":{},"bodyParametersJson":"={\"chatId\": \"={{ $json.body.chatId }}\",\"text\": {\"body\": \"✅ Agendamento confirmado!\\nSeu horário: {{ new Date($json.horarioSelecionado).toLocaleString('pt-BR', {dateStyle:'short', timeStyle:'short'}) }}\"}}"},"name":"Enviar Confirmação WhatsApp","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[1456,256],"id":"65af2fec-7e69-40a6-932b-d07972724046"}],"connections":{"Gatilho WhatsApp":{"main":[[{"node":"Verifica Mensagem Vazia","type":"main","index":0}]]},"Verifica Mensagem Vazia":{"main":[[{"node":"Buscar Usuário","type":"main","index":0}]]},"Buscar Usuário":{"main":[[{"node":"Verifica Se Cria Paciente","type":"main","index":0}]]},"Verifica Se Cria Paciente":{"main":[[{"node":"Calcular Horários Livres","type":"main","index":0}]]},"Calcular Horários Livres":{"main":[[{"node":"Interpretar Escolha","type":"main","index":0}]]},"Interpretar Escolha":{"main":[[{"node":"Criar Evento Google Calendar","type":"main","index":0}]]},"Criar Evento Google Calendar":{"main":[[{"node":"Enviar Confirmação WhatsApp","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateId":"1954","templateCredsSetupCompleted":true},"pinData":{},"versionId":"a629df85-54e0-4899-83a6-334cc1d69cdf","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-13T18:44:44.286Z","createdAt":"2025-12-13T18:44:44.286Z","role":"workflow:owner","workflowId":"BroWHCVVUnywRqMM","projectId":"ej8gVdo1FjD7Hco2"}],"activeVersion":null,"tags":[]}